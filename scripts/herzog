#!/usr/bin/env python
import argparse
import json
import os
import sys

from typing import List, Optional

pkg_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))  # noqa
sys.path.insert(0, pkg_root)  # noqa

import herzog


def check_file_type(file_name: str) -> str:
    if file_name.endswith('.ipynb'):
        return 'ipynb'
    elif file_name.endswith('.py'):
        return 'herzog'
    else:
        raise NotImplementedError(f'Unsupported file extension: {file_name}')


def main(args: Optional[List[str]] = None) -> None:
    if args is None:
        args = sys.argv[1:]

    if len(args) == 1 and args[0] not in ('--help', '-h', '--version', '-v'):
        # maintain backwards compatibility
        with open(args[0]) as fh:
            print(json.dumps(herzog.translate_to_ipynb(fh), indent=2))
            exit()

    parser = argparse.ArgumentParser(prog='Herzog',
                                     description='Developer tool to translate notebooks to runnable code and '
                                                 'back again, allowing notebooks to be written, reviewed, '
                                                 'and versioned-controlled as normal code.')
    subparser = parser.add_subparsers()
    convert = subparser.add_parser('convert')
    convert.add_argument('--input', '-i', type=str, required=True,
                         help="The name of an input file.  Type will be inferred by the extension "
                              "('.ipynb' or '.py').")
    convert.add_argument('--output', '-o', type=str, required=False, default=None,
                         help=f"The name of an output file.  Type will be inferred by the extension "
                              f"('.ipynb' or '.py').  The type must not be the same as the input type.  "
                              f"If this is not specified, output will be printed to stdout.")
    options = parser.parse_args()

    input_type = check_file_type(options.input)
    assert os.path.exists(options.input)
    output_type = check_file_type(options.output) if options.output else None

    if input_type == output_type:
        raise ValueError(f'File types for input and output are the same.  Please check your file extensions.  '
                         f'Conversions should be either from a notebook (".ipynb") to herzog (".py") or vice versa.'
                         f'\nInput: {options.input}\nOutput: {options.output}')

    with open(options.input, 'r') as r:
        if input_type == 'herzog':
            output_file_contents = json.dumps(herzog.translate_to_ipynb(r), indent=2)
        elif input_type == 'ipynb':
            output_file_contents = ''.join([line for line in herzog.translate_to_herzog(r)])
        else:
            raise NotImplementedError(f'Input type: "{input_type}" not supported.')

    if output_type:
        with open(options.output, 'w') as w:
            w.write(output_file_contents)
    else:
        print(output_file_contents)


if __name__ == "__main__":
    main()
